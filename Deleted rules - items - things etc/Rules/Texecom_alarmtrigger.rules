// ***************************
// Texecom ALARM TRIGGERED - Send Mail Notification
// ***************************

// Fixed for openHAB 5

rule "Texecom ALARM TRIGGERED - Send Mail Notification"
when
    // Trigger when the alarm status changes to 3 (Alarm Triggered)
    Item Tex_Alarm_Status changed to 3
then

    logInfo("TEXECOM ALARM TRIGGERED", "ALARM ON TERNDRUPVEJ 81")

    // Get the mail action instance once at the start of the rule
    // Replace "mail:smtp:samplesmtp" with the actual Thing UID of your mail binding configuration
    val mailActions = getActions("mail","mail:smtp:samplesmtp")

    // Check if the mail action was retrieved successfully
    if (mailActions === null) {
        logError("Texecom Notification", "Mail action not found or configured correctly.")
        return // Stop the rule if mail actions aren't available
    }
    
    val subject = "ALARM ON TERNDRUPVEJ"
    val body = "ALARM ON TERNDRUPVEJ 81"
    
    // Define the recipients list
    val recipients = newArrayList("Nanna@agesen.dk", "20960210@sms.uni-tel.dk", "Henrik@agesen.dk", "40682150@sms.uni-tel.dk")

    // Loop through recipients and send mail
    recipients.forEach[recipient |
        val success = mailActions.sendMail(recipient, subject, body)
        // Use placeholders {} for better logging practice
        logInfo("Texecom Notification", "Mail sent to {}. Success status: {}", recipient, success)
    ]
end