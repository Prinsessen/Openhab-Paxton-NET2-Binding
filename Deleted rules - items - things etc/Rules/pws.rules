import java.time.ZonedDateTime // Required for modern time API
import java.time.format.DateTimeFormatter // Required for formatting dates in logs

// Optimized for OpenHAB 5

rule "Max wind speed"
when
    Item WeatherWindSpeed received update
then
    // Use 'as Number' for casting
    var max = (WeatherWindSpeed.state as Number).doubleValue

    if (WindSpeedMax.state === NULL || WindSpeedMax.state === UNDEF) {
        WindSpeedMax.postUpdate(0)
    }
    
    var maxspeed = (WindSpeedMax.state as Number).doubleValue
    
    if (max > maxspeed) {
        WindSpeedMax.postUpdate(max)
        logInfo("Windspeed", "New Max Wind Speed: " + WindSpeedMax.state)

        // Use ZonedDateTime for modern time handling
        dateWindSpeedMax.postUpdate(ZonedDateTime.now().toString)
        logInfo("Windspeed", "Date: " + dateWindSpeedMax.state)
        
        // Persistence action remains valid if configured in services/influxdb.cfg
        dateWindSpeedMax.persist("influxdb") 
    }
end

rule "Max wind gust"
when
    Item WeatherWindGust received update
then
    // Use 'as Number' for casting
    var gust = (WeatherWindGust.state as Number).doubleValue

    if (WindGustMax.state === NULL || WindGustMax.state === UNDEF) {
        WindGustMax.postUpdate(0)
    }
    
    var maxgust = (WindGustMax.state as Number).doubleValue
    
    if (gust > maxgust) {
        WindGustMax.postUpdate(gust)
        logInfo("WindGust", "New Max Wind Gust: " + WindGustMax.state)
        
        // Use ZonedDateTime for modern time handling
        dateWindGustMax.postUpdate(ZonedDateTime.now().toString)
        logInfo("WindsGust", "Date: " + dateWindGustMax.state)
        
        // Persistence action remains valid if configured in services/influxdb.cfg
        dateWindGustMax.persist("influxdb") 
    }
end