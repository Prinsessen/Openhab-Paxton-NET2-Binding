// ***************************
// Process information from UDP interface in openHAB 5
// ***************************

// Optimized for openHAB5

rule "Alarm interface via UDP"
when   
    // The trigger condition remains the same as openHAB 5 still supports this syntax.
    Item  Tex_UDP_Receive received update
then
    // Define the core actions handler first for cleaner code in the modern API environment
    val core = actions.byUID("openhab", "core")

	// We need to trim the incoming UDP package, since that sometimes contains trailing NULL characters.
	var in_UDPmsg = Tex_UDP_Receive.state.toString.trim

    // To translate UDP zone-updates (Z) to our individual zone-items.
    if(in_UDPmsg.startsWith("\"Z00")) {
        // Ensure the substring index is correct for your item naming convention
        val itemName = "Tex_Zone_"+in_UDPmsg.substring(1, 5) 
        // Use the modern API call
        core.postUpdate(itemName, in_UDPmsg.substring(5))
        core.logInfo("Texecom", "Texecom - Zone Active: {}", itemName)
    }
	
	
    // When alarm is Armed (A) we register who armed it.
	else if(in_UDPmsg.startsWith("\"A0")) {
        core.postUpdate(Tex_Alarm_Status, "1")
        // Use ZonedDateTime.now() to get the current time object for a DateTime Item
		core.postUpdate(Tex_Alarm_Status_Update, org.openhab.core.library.types.DateTimeType.fromZonedDateTime(java.time.ZonedDateTime.now()))
		core.postUpdate(Tex_Alarm_Partition, in_UDPmsg.substring(2, 5))
		core.postUpdate(Tex_Alarm_ArmDisarmUser, in_UDPmsg.substring(5, in_UDPmsg.length))
		core.logInfo("Texecom", "Texecom - Armed by - Rule")
    }

	// When alarm is Disarmed (D) we register who disarmed it.
	else if(in_UDPmsg.startsWith("\"D0")) {
        core.postUpdate(Tex_Alarm_Status, "0")
        // Use ZonedDateTime.now() for the current time
		core.postUpdate(Tex_Alarm_Status_Update, org.openhab.core.library.types.DateTimeType.fromZonedDateTime(java.time.ZonedDateTime.now()))
		core.postUpdate(Tex_Alarm_Partition, in_UDPmsg.substring(2, 5))
		core.postUpdate(Tex_Alarm_ArmDisarmUser, in_UDPmsg.substring(5, in_UDPmsg.length))
		core.logInfo("Texecom", "Texecom - Disarmed by - Rule")
	}

	// When a user is logged on to the keypad (U), we register the user ID.
	else if(in_UDPmsg.startsWith("\"U0")) {
		core.postUpdate(Tex_Alarm_User, in_UDPmsg.substring(4, 5))	
		core.logInfo("Texecom", "Texecom - User logged on to the keypad By Rule")
	} 

	// We need to process the response to our ASTATUS call.
	else if(in_UDPmsg.startsWith("\"NNNNN")) {
		if (Tex_Alarm_Status.state.toString == "1") { 
			core.postUpdate(Tex_Alarm_Status, "0")
			core.logInfo("Texecom", "Texecom - Armed By Rule")
		} 
	} 
	else if(in_UDPmsg.startsWith("\"YNNNN")) {
		if (Tex_Alarm_Status.state.toString == "0") {
			core.logInfo("Texecom", "Texecom - Armed by rule")
			core.postUpdate(Tex_Alarm_Status, "1")
		// Also when the alarm is in exit mode, we should change the status.
		} else if (Tex_Alarm_Status.state.toString == "2") {
			core.postUpdate(Tex_Alarm_Status, "1")
			core.logInfo("Texecom", "Texecom - In Exit Mode by rule")
		}
	} 
	// Messages not related to zone/area/user updates are typically what is displayed on the alarm keypad.
	else {
		// There is no separate UDP message that registers when the alarm has been triggered/activated.
		if(in_UDPmsg.startsWith("\"System Alerts!") && Tex_Alarm_Status.state.toString != "3") {
			core.postUpdate(Tex_Alarm_Status, "3")
			core.postUpdate(Tex_Alarm_Status_Update, org.openhab.core.library.types.DateTimeType.fromZonedDateTime(java.time.ZonedDateTime.now()))
			core.logInfo("Texecom", "Texecom - Nanna System Alerts!")
		}
		else if(in_UDPmsg.startsWith("\"Area in Alarm") && Tex_Alarm_Status.state.toString != "3") {
			core.postUpdate(Tex_Alarm_Status, "3")
			core.postUpdate(Tex_Alarm_Status_Update, org.openhab.core.library.types.DateTimeType.fromZonedDateTime(java.time.ZonedDateTime.now()))
			core.logInfo("Texecom", "Texecom - Nanna Zone Active!")
		}
		// There is no separate UDP message that registers when the alarm is in exit mode.
		else if(in_UDPmsg.startsWith("\"Partit.in Uitl.") && Tex_Alarm_Status.state.toString != "2") {
			core.postUpdate(Tex_Alarm_Status, "2")
			core.postUpdate(Tex_Alarm_Status_Update, org.openhab.core.library.types.DateTimeType.fromZonedDateTime(java.time.ZonedDateTime.now()))
		}
		// There is no separate UDP message that registers when the exit mode has failed.
		else if(in_UDPmsg.startsWith("\"wapening gefaald") && Tex_Alarm_Status.state.toString != "4") {
			core.postUpdate(Tex_Alarm_Status, "4")
			core.postUpdate(Tex_Alarm_Status_Update, org.openhab.core.library.types.DateTimeType.fromZonedDateTime(java.time.ZonedDateTime.now()))
		}
	// The information displayed on the key pad needs to split back in two (as on the keypad itself).
		if (in_UDPmsg.length < 17) {
			core.postUpdate(Tex_Alarm_Textline1, in_UDPmsg.substring(1, in_UDPmsg.length))
		} else if (in_UDPmsg.length > 16) {
			core.postUpdate(Tex_Alarm_Textline1, in_UDPmsg.substring(1, 17))
			core.postUpdate(Tex_Alarm_Textline2, in_UDPmsg.substring(17, in_UDPmsg.length))			
		}
	}
end