// =============================================================================
// Springfield Ignition Notification Rules
// =============================================================================
// Sends email notifications when Springfield (FMM920 tracker) ignition
// turns on or off, including location, map link, and vehicle telemetry
// =============================================================================

var Long lastIgnitionOnTime = 0L
var Long lastIgnitionOffTime = 0L

rule "Springfield Ignition ON Notification"
when
    Item Vehicle10_Ignition changed from OFF to ON
then
    try {
        // Debounce: Prevent duplicate notifications within 30 seconds
        val currentTime = new java.util.Date().time
        if ((currentTime - lastIgnitionOnTime) < 30000) {
            logInfo("springfield_ignition", "Ignition ON triggered too soon after last notification - skipping")
            return
        }
        lastIgnitionOnTime = currentTime
        
        // Get current vehicle data
        val position = Vehicle10_Position.state.toString
        val address = if (Vehicle10_Address.state != NULL) Vehicle10_Address.state.toString else "Address not available"
        val speedState = Vehicle10_Speed.state
        val speed = if (speedState != NULL) String.format("%.1f km/h", (speedState as Number).doubleValue) else "0 km/h"
        val odometerState = Vehicle10_TotalDistance.state
        val odometer = if (odometerState != NULL) String.format("%.1f km", (odometerState as Number).doubleValue) else "Unknown"
        logInfo("springfield_ignition", "Ignition ON - Odometer: " + odometer + " (raw: " + odometerState + ")")
        val hoursState = Vehicle10_Hours.state
        val hours = if (hoursState != NULL) String.format("%.1f h", (hoursState as Number).doubleValue) else "Unknown"
        val satellites = if (Vehicle10_GpsSatellites.state != NULL) Vehicle10_GpsSatellites.state.toString else "Unknown"
        
        // Format timestamp properly
        val dateFormat = new java.text.SimpleDateFormat("dd/MM HH:mm")
        val timestamp = dateFormat.format(new java.util.Date())
        
        // Extract latitude and longitude from position
        val coords = position.split(",")
        val latitude = coords.get(0)
        val longitude = coords.get(1)
        
        // Create map links
        val googleMapsLink = "https://www.google.com/maps?q=" + latitude + "," + longitude
        val openStreetMapLink = "https://www.openstreetmap.org/?mlat=" + latitude + "&mlon=" + longitude + "&zoom=16"
        
        logInfo("springfield_ignition", "üî• Ignition ON detected - Sending notification email")
        
        // Get mail actions using method call style
        val mailActions = getActions("mail","mail:smtp:samplesmtp")
        
        // Send detailed HTML email notification
        val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
            "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #667eea; color: white;'>" +
            "<tr><td style='padding: 20px;'>" +
            "<h2 style='margin: 0; margin-bottom: 5px;'>üèçÔ∏è SPRINGFIELD STARTED</h2>" +
            "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>DreamCatcher - Indian Springfield 1811ccm</p>" +
            "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
            "</td></tr>" +
            "</table>" +
            "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #e3f2fd;'>" +
            "<tr><td style='padding: 15px;'>" +
            "<h3 style='color: #667eea; margin: 0; margin-bottom: 10px;'>üìç Location</h3>" +
            "<p style='margin: 5px 0; font-size: 14px;'>" + address + "</p>" +
            "<p style='margin: 5px 0; color: #666; font-size: 13px;'>" + latitude + ", " + longitude + "</p>" +
            "<p style='margin: 10px 0 5px 0;'><a href='" + googleMapsLink + "' style='color: #667eea; text-decoration: none; font-weight: bold;'>üìç Google Maps</a> | " +
            "<a href='" + openStreetMapLink + "' style='color: #667eea; text-decoration: none;'>üó∫Ô∏è OpenStreetMap</a></p>" +
            "</td></tr>" +
            "</table>" +
            "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
            "<tr><td style='padding: 10px; background: #e8f5e9;'><strong>üî• Ignition:</strong> ON</td></tr>" +
            "<tr><td style='padding: 10px; background: #fff3e0;'><strong>‚ö° Speed:</strong> " + speed + "</td></tr>" +
            "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>üìè Odometer:</strong> " + odometer + "</td></tr>" +
            "<tr><td style='padding: 10px; background: #f3e5f5;'><strong>‚è±Ô∏è Hours:</strong> " + hours + "</td></tr>" +
            "<tr><td style='padding: 10px; background: #e0f2f1;'><strong>üì° GPS:</strong> " + satellites + " sats</td></tr>" +
            "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
            "<p style='margin: 0; color: #666; font-size: 13px;'><strong>Device:</strong> Springfield FMM920 (ID: 10)</p>" +
            "</td></tr>" +
            "</table>" +
            "</body></html>"
        
        val success1 = mailActions.sendHtmlMail("nanna@agesen.dk", "Springfield Ignition ON", emailBody)
        logInfo("springfield_ignition", "Ignition ON email status: " + success1)
        
        val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "Springfield Ignition ON", "Springfield ignition started at " + timestamp + ". Location: " + address)
        logInfo("springfield_ignition", "Ignition ON SMS status: " + success2)
        
    } catch (Exception e) {
        logError("springfield_ignition", "Error sending ignition ON notification: " + e.getMessage())
    }
end

rule "Springfield Ignition OFF Notification"
when
    Item Vehicle10_Ignition changed from ON to OFF
then
    try {
        // Debounce: Prevent duplicate notifications within 30 seconds
        val currentTime = new java.util.Date().time
        if ((currentTime - lastIgnitionOffTime) < 30000) {
            logInfo("springfield_ignition", "Ignition OFF triggered too soon after last notification - skipping")
            return
        }
        lastIgnitionOffTime = currentTime
        
        // Get current vehicle data
        val position = Vehicle10_Position.state.toString
        val address = if (Vehicle10_Address.state != NULL) Vehicle10_Address.state.toString else "Address not available"
        val odometerState = Vehicle10_TotalDistance.state
        val odometer = if (odometerState != NULL) String.format("%.1f km", (odometerState as Number).doubleValue) else "Unknown"
        logInfo("springfield_ignition", "Ignition OFF - Odometer: " + odometer + " (raw: " + odometerState + ")")
        val hoursState = Vehicle10_Hours.state
        val hours = if (hoursState != NULL) String.format("%.1f h", (hoursState as Number).doubleValue) else "Unknown"
        val satellites = if (Vehicle10_GpsSatellites.state != NULL) Vehicle10_GpsSatellites.state.toString else "Unknown"
        
        // Format timestamp properly
        val dateFormat = new java.text.SimpleDateFormat("dd/MM HH:mm")
        val timestamp = dateFormat.format(new java.util.Date())
        
        // Extract latitude and longitude from position
        val coords = position.split(",")
        val latitude = coords.get(0)
        val longitude = coords.get(1)
        
        // Create map links
        val googleMapsLink = "https://www.google.com/maps?q=" + latitude + "," + longitude
        val openStreetMapLink = "https://www.openstreetmap.org/?mlat=" + latitude + "&mlon=" + longitude + "&zoom=16"
        
        logInfo("springfield_ignition", "üîå Ignition OFF detected - Sending notification email")
        
        // Get mail actions using method call style
        val mailActions = getActions("mail","mail:smtp:samplesmtp")
        
        // Send detailed HTML email notification
        val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
            "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #f5576c; color: white;'>" +
            "<tr><td style='padding: 20px;'>" +
            "<h2 style='margin: 0; margin-bottom: 5px;'>üÖøÔ∏è SPRINGFIELD PARKED</h2>" +
            "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>DreamCatcher - Indian Springfield 1811ccm</p>" +
            "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
            "</td></tr>" +
            "</table>" +
            "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #e3f2fd;'>" +
            "<tr><td style='padding: 15px;'>" +
            "<h3 style='color: #f5576c; margin: 0; margin-bottom: 10px;'>üìç Parked Location</h3>" +
            "<p style='margin: 5px 0; font-size: 14px;'>" + address + "</p>" +
            "<p style='margin: 5px 0; color: #666; font-size: 13px;'>" + latitude + ", " + longitude + "</p>" +
            "<p style='margin: 10px 0 5px 0;'><a href='" + googleMapsLink + "' style='color: #f5576c; text-decoration: none; font-weight: bold;'>üìç Google Maps</a> | " +
            "<a href='" + openStreetMapLink + "' style='color: #f5576c; text-decoration: none;'>üó∫Ô∏è OpenStreetMap</a></p>" +
            "</td></tr>" +
            "</table>" +
            "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
            "<tr><td style='padding: 10px; background: #ffebee;'><strong>üîå Ignition:</strong> OFF</td></tr>" +
            "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>üìè Odometer:</strong> " + odometer + "</td></tr>" +
            "<tr><td style='padding: 10px; background: #f3e5f5;'><strong>‚è±Ô∏è Hours:</strong> " + hours + "</td></tr>" +
            "<tr><td style='padding: 10px; background: #e0f2f1;'><strong>üì° GPS:</strong> " + satellites + " sats</td></tr>" +
            "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
            "<p style='margin: 0; color: #666; font-size: 13px;'><strong>Device:</strong> Springfield FMM920 (ID: 10)</p>" +
            "</td></tr>" +
            "</table>" +
            "</body></html>"
        
        val success1 = mailActions.sendHtmlMail("nanna@agesen.dk", "Springfield Ignition OFF - Parked", emailBody)
        logInfo("springfield_ignition", "Ignition OFF email status: " + success1)
        
        val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "Springfield Parked", "Springfield parked at " + timestamp + ". Location: " + address)
        logInfo("springfield_ignition", "Ignition OFF SMS status: " + success2)
        
    } catch (Exception e) {
        logError("springfield_ignition", "Error sending ignition OFF notification: " + e.getMessage())
    }
end
