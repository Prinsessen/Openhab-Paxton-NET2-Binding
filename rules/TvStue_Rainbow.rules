// TV Stue ULTRA Fancy Rainbow Effect with Dynamic Breathing
// Features: Smooth color flow + brightness breathing + saturation waves
// Optimized for OpenHAB 5 with non-blocking timer architecture

var Timer rainbowTimer = null
var int currentColorIndex = 0
var boolean brightnessIncreasing = true
var int currentBrightness = 85

// Ultra-smooth Rainbow: 72 colors (5-degree steps) for liquid-smooth transitions
val rainbowColors = newArrayList(
    "0", "5", "10", "15", "20", "25", "30", "35", "40", "45", "50", "55",      // Red -> Orange -> Yellow
    "60", "65", "70", "75", "80", "85", "90", "95", "100", "105", "110", "115", // Yellow -> Green
    "120", "125", "130", "135", "140", "145", "150", "155", "160", "165", "170", "175", // Green -> Cyan
    "180", "185", "190", "195", "200", "205", "210", "215", "220", "225", "230", "235", // Cyan -> Blue
    "240", "245", "250", "255", "260", "265", "270", "275", "280", "285", "290", "295", // Blue -> Purple
    "300", "305", "310", "315", "320", "325", "330", "335", "340", "345", "350", "355"  // Purple -> Magenta -> Red
)

// Dynamic saturation wave for extra depth
val saturationWave = newArrayList(
    "100", "98", "95", "92", "90", "92", "95", "98" // Subtle breathing saturation
)

rule "TV Stue Rainbow Mode Started"
when
    Item TvStue_Rainbow_Mode changed to ON
then
    logInfo("TvStue_Rainbow", "ULTRA FANCY Rainbow mode activated for TV Stue lightstrip!")
    
    // Cancel any existing animation
    if (rainbowTimer !== null && !rainbowTimer.hasTerminated) {
        rainbowTimer.cancel
        logDebug("TvStue_Rainbow", "Cancelled previous rainbow timer")
    }
    
    // Turn on the light if it's off
    if (Light2_Toggle.state != ON) {
        Light2_Toggle.sendCommand(ON)
        logDebug("TvStue_Rainbow", "Turned on TV Stue light")
    }
    
    // Reset animation state
    currentColorIndex = 0
    currentBrightness = 85
    brightnessIncreasing = true
    
    // Start the rainbow animation with dynamic breathing effect
    val hue = rainbowColors.get(currentColorIndex)
    val saturation = saturationWave.get(0)
    Light2_Color.sendCommand(hue + "," + saturation + "," + currentBrightness)
    logDebug("TvStue_Rainbow", "Ultra Rainbow Mode: Starting with HSB " + hue + "," + saturation + "," + currentBrightness)
    
    // Trigger first cycle immediately
    TvStue_Rainbow_Mode.postUpdate(ON)
end

rule "TV Stue Rainbow Mode Cycle"
when
    Item TvStue_Rainbow_Mode received update ON
then
    // Only cycle if rainbow mode is ON (not just triggered by update)
    if (TvStue_Rainbow_Mode.state == ON && currentColorIndex >= 0) {
        // Move to next color in ultra-smooth progression
        currentColorIndex = (currentColorIndex + 1) % rainbowColors.size
        
        // Dynamic breathing brightness (oscillates 70-100 for mesmerizing pulse)
        if (brightnessIncreasing) {
            currentBrightness = currentBrightness + 2
            if (currentBrightness >= 100) {
                currentBrightness = 100
                brightnessIncreasing = false
            }
        } else {
            currentBrightness = currentBrightness - 2
            if (currentBrightness <= 70) {
                currentBrightness = 70
                brightnessIncreasing = true
            }
        }
        
        // Get color with dynamic saturation wave
        val hue = rainbowColors.get(currentColorIndex)
        val satIndex = (currentColorIndex / 9) % saturationWave.size  // Slower saturation changes
        val saturation = saturationWave.get(satIndex)
        
        // Apply the ultra-fancy color with breathing effect
        Light2_Color.sendCommand(hue + "," + saturation + "," + currentBrightness)
        logDebug("TvStue_Rainbow", "Rainbow [" + currentColorIndex + "/72] HSB: " + hue + "," + saturation + "," + currentBrightness)
        
        // Smooth 4-second transitions for full 5-minute rainbow cycle (72 colors × 4 sec = 288 sec ≈ 5 min)
        rainbowTimer = createTimer(now.plusSeconds(4)) [ |
            TvStue_Rainbow_Mode.postUpdate(ON)  // Trigger next cycle
        ]
    }
end

rule "TV Stue Rainbow Mode Stopped"
when
    Item TvStue_Rainbow_Mode changed to OFF
then
    logInfo("TvStue_Rainbow", "ULTRA FANCY Rainbow mode deactivated for TV Stue lightstrip")
    
    // Cancel the animation timer
    if (rainbowTimer !== null && !rainbowTimer.hasTerminated) {
        rainbowTimer.cancel
        logDebug("TvStue_Rainbow", "Stopped rainbow animation")
    }
    
    // Reset animation state
    currentColorIndex = 0
    currentBrightness = 85
    brightnessIncreasing = true
end
