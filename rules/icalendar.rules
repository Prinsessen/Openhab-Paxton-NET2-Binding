// =============================================================================
// iCalendar Combined Event Display Rules
// =============================================================================
// Combines calendar event name and datetime into single formatted string
// for cleaner sitemap display
// =============================================================================

import java.time.format.DateTimeFormatter
import java.util.Locale

// =============================================================================
// Lauge's Next Event - Combined Display
// =============================================================================
// Combines Lauge_Next_event_name and Lauge_Next_event_at into single string
// Format: "EventName - Dayname, dd-mm-yyyy - HH:MM:SS"
// Example: "Meeting - onsdag, 29-01-2026 - 14:30:00"
// =============================================================================

rule "Update Lauge Combined Event Display"
when
    Item Lauge_Next_event_name changed or
    Item Lauge_Next_event_at changed
then
    try {
        // Check if both items have valid values
        if (Lauge_Next_event_name.state === NULL || Lauge_Next_event_name.state === UNDEF ||
            Lauge_Next_event_at.state === NULL || Lauge_Next_event_at.state === UNDEF) {
            Lauge_Next_Event_Combined.postUpdate("Ingen kommende events")
            return
        }
        
        // Get event name
        val eventName = Lauge_Next_event_name.state.toString
        
        // Get datetime and parse it (OpenHAB format includes milliseconds)
        val inputFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss.SSSZ")
        val zonedDateTime = java.time.ZonedDateTime.parse(Lauge_Next_event_at.state.toString, inputFormatter)
        
        // Format datetime: Dayname, dd-mm-yyyy - HH:MM:SS
        val formatter = DateTimeFormatter.ofPattern("EEEE, dd-MM-yyyy - HH:mm:ss", Locale.of("da", "DK"))
        val formattedDateTime = zonedDateTime.format(formatter)
        
        // Combine: "EventName - Dayname, dd-mm-yyyy - HH:MM:SS"
        val combined = eventName + " - " + formattedDateTime
        
        // Update combined item
        Lauge_Next_Event_Combined.postUpdate(combined)
        
        logDebug("iCalendar", "Updated Lauge combined event: {}", combined)
        
    } catch (Exception e) {
        logError("iCalendar", "Error updating Lauge combined event display: {}", e.getMessage())
        Lauge_Next_Event_Combined.postUpdate("Fejl ved visning af event")
    }
end

// =============================================================================
// Nanna's Next Event - Combined Display
// =============================================================================
// Combines next_event_name and next_event_at into single string
// Format: "EventName - Dayname, dd-mm-yyyy - HH:MM:SS"
// Example: "Meeting - onsdag, 29-01-2026 - 14:30:00"
// =============================================================================

rule "Update Nanna Combined Event Display"
when
    Item next_event_name changed or
    Item next_event_at changed
then
    try {
        // Check if both items have valid values
        if (next_event_name.state === NULL || next_event_name.state === UNDEF ||
            next_event_at.state === NULL || next_event_at.state === UNDEF) {
            Next_Event_Combined.postUpdate("Ingen kommende events")
            return
        }
        
        // Get event name
        val eventName = next_event_name.state.toString
        
        // Get datetime and parse it (OpenHAB format includes milliseconds)
        val inputFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss.SSSZ")
        val zonedDateTime = java.time.ZonedDateTime.parse(next_event_at.state.toString, inputFormatter)
        
        // Format datetime: Dayname, dd-mm-yyyy - HH:MM:SS
        val formatter = DateTimeFormatter.ofPattern("EEEE, dd-MM-yyyy - HH:mm:ss", Locale.of("da", "DK"))
        val formattedDateTime = zonedDateTime.format(formatter)
        
        // Combine: "EventName - Dayname, dd-mm-yyyy - HH:MM:SS"
        val combined = eventName + " - " + formattedDateTime
        
        // Update combined item
        Next_Event_Combined.postUpdate(combined)
        
        logDebug("iCalendar", "Updated Nanna combined event: {}", combined)
        
    } catch (Exception e) {
        logError("iCalendar", "Error updating Nanna combined event display: {}", e.getMessage())
        Next_Event_Combined.postUpdate("Fejl ved visning af event")
    }
end
