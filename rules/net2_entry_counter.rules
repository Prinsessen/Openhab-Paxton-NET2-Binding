// ==============================================
// Net2 Entry Log Counter and Field Parser
// Creates separate persisted items for Grafana tables
// ==============================================

rule "Net2 Door1 Entry Counter"
when
    Item Net2_Door1_EntryLog changed
then
    var count = 0
    if (Net2_Door1_EntryCount.state instanceof Number) {
        count = (Net2_Door1_EntryCount.state as Number).intValue()
    }
    count = count + 1
    
    // Parse JSON and extract ALL fields
    val String json = Net2_Door1_EntryLog.state.toString
    val firstName = transform("JSONPATH", "$.firstName", json)
    val lastName = transform("JSONPATH", "$.lastName", json)
    val doorName = transform("JSONPATH", "$.doorName", json)
    val fullName = firstName + " " + lastName
    
    logInfo("Net2Entry", "Door1: json=" + json)
    logInfo("Net2Entry", "Door1: firstName=" + firstName + ", lastName=" + lastName + ", doorName=" + doorName)
    
    // Update separate items - each persisted individually
    Net2_Door1_EntryCount.postUpdate(count)
    Net2_Door1_EntryFullName.postUpdate(fullName)
    Net2_Door1_EntryDoorName.postUpdate(doorName)
    Net2_Door1_EntryFirstName.postUpdate(firstName)
    Net2_Door1_EntryLastName.postUpdate(lastName)
end

rule "Net2 Door2 Entry Counter"
when
    Item Net2_Door2_EntryLog changed
then
    var count = 0
    if (Net2_Door2_EntryCount.state instanceof Number) {
        count = (Net2_Door2_EntryCount.state as Number).intValue()
    }
    count = count + 1
    
    val String json = Net2_Door2_EntryLog.state.toString
    val firstName = transform("JSONPATH", "$.firstName", json)
    val lastName = transform("JSONPATH", "$.lastName", json)
    val doorName = transform("JSONPATH", "$.doorName", json)
    val fullName = firstName + " " + lastName
    
    Net2_Door2_EntryCount.postUpdate(count)
    Net2_Door2_EntryFullName.postUpdate(fullName)
    Net2_Door2_EntryDoorName.postUpdate(doorName)
    Net2_Door2_EntryFirstName.postUpdate(firstName)
    Net2_Door2_EntryLastName.postUpdate(lastName)
end

rule "Net2 Door3 Entry Counter"
when
    Item Net2_Door3_EntryLog changed
then
    var count = 0
    if (Net2_Door3_EntryCount.state instanceof Number) {
        count = (Net2_Door3_EntryCount.state as Number).intValue()
    }
    count = count + 1
    
    val String json = Net2_Door3_EntryLog.state.toString
    val firstName = transform("JSONPATH", "$.firstName", json)
    val lastName = transform("JSONPATH", "$.lastName", json)
    val doorName = transform("JSONPATH", "$.doorName", json)
    val fullName = firstName + " " + lastName
    
    Net2_Door3_EntryCount.postUpdate(count)
    Net2_Door3_EntryFullName.postUpdate(fullName)
    Net2_Door3_EntryDoorName.postUpdate(doorName)
    Net2_Door3_EntryFirstName.postUpdate(firstName)
    Net2_Door3_EntryLastName.postUpdate(lastName)
end

rule "Net2 Door4 Entry Counter"
when
    Item Net2_Door4_EntryLog changed
then
    var count = 0
    if (Net2_Door4_EntryCount.state instanceof Number) {
        count = (Net2_Door4_EntryCount.state as Number).intValue()
    }
    count = count + 1
    
    val String json = Net2_Door4_EntryLog.state.toString
    val firstName = transform("JSONPATH", "$.firstName", json)
    val lastName = transform("JSONPATH", "$.lastName", json)
    val doorName = transform("JSONPATH", "$.doorName", json)
    val fullName = firstName + " " + lastName
    
    Net2_Door4_EntryCount.postUpdate(count)
    Net2_Door4_EntryFullName.postUpdate(fullName)
    Net2_Door4_EntryDoorName.postUpdate(doorName)
    Net2_Door4_EntryFirstName.postUpdate(firstName)
    Net2_Door4_EntryLastName.postUpdate(lastName)
end

rule "Net2 Door5 Entry Counter"
when
    Item Net2_Door5_EntryLog changed
then
    var count = 0
    if (Net2_Door5_EntryCount.state instanceof Number) {
        count = (Net2_Door5_EntryCount.state as Number).intValue()
    }
    count = count + 1
    
    val String json = Net2_Door5_EntryLog.state.toString
    val firstName = transform("JSONPATH", "$.firstName", json)
    val lastName = transform("JSONPATH", "$.lastName", json)
    val doorName = transform("JSONPATH", "$.doorName", json)
    val fullName = firstName + " " + lastName
    
    Net2_Door5_EntryCount.postUpdate(count)
    Net2_Door5_EntryFullName.postUpdate(fullName)
    Net2_Door5_EntryDoorName.postUpdate(doorName)
    Net2_Door5_EntryFirstName.postUpdate(firstName)
    Net2_Door5_EntryLastName.postUpdate(lastName)
end
