// =============================================================================
// Lauge Calendar Event Reminder
// =============================================================================
// Announces upcoming events from Lauge's calendar 15 minutes before they start
// Uses OpenHAB's say() action for text-to-speech announcement
// Updated: 2026-01-29
// =============================================================================

import java.time.ZonedDateTime
import java.time.temporal.ChronoUnit

var Timer laugeReminderTimer = null

// =============================================================================
// Rule: Schedule reminder when Lauge's next event changes
// =============================================================================
// Triggers when the next event datetime changes
// Calculates 15 minutes before event start
// Creates timer to fire reminder at the calculated time
// =============================================================================

rule "Schedule Lauge Event Reminder"
when
    Item Lauge_Next_event_at changed
then
    try {
        // Cancel existing timer if any
        if (laugeReminderTimer !== null && !laugeReminderTimer.hasTerminated) {
            laugeReminderTimer.cancel()
            laugeReminderTimer = null
            logDebug("LaugeReminder", "Cancelled existing reminder timer")
        }
        
        // Check if event time is valid
        if (Lauge_Next_event_at.state === NULL || Lauge_Next_event_at.state === UNDEF ||
            Lauge_Next_event_name.state === NULL || Lauge_Next_event_name.state === UNDEF) {
            logDebug("LaugeReminder", "No valid event found, skipping reminder setup")
            return
        }
        
        // Parse event time
        val inputFormatter = java.time.format.DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss.SSSZ")
        val eventTime = ZonedDateTime.parse(Lauge_Next_event_at.state.toString, inputFormatter)
        
        // Calculate reminder time (15 minutes before event)
        val reminderTime = eventTime.minusMinutes(15)
        val now = ZonedDateTime.now()
        
        // Only schedule if reminder time is in the future
        if (reminderTime.isAfter(now)) {
            val minutesUntilReminder = ChronoUnit.MINUTES.between(now, reminderTime)
            
            logInfo("LaugeReminder", "Scheduling reminder for '{}' at {} ({} minutes from now)",
                Lauge_Next_event_name.state.toString,
                reminderTime.format(java.time.format.DateTimeFormatter.ofPattern("HH:mm")),
                minutesUntilReminder)
            
            // Store event time as final value for use in timer callback
            val finalEventTime = eventTime
            
            // Create timer to fire at reminder time using now.plusMinutes
            laugeReminderTimer = createTimer(now.plusMinutes(minutesUntilReminder)) [ |
                // Get event name and time
                val eventName = Lauge_Next_event_name.state.toString
                val eventTimeFormatted = finalEventTime.format(java.time.format.DateTimeFormatter.ofPattern("HH:mm"))
                
                // Calculate actual minutes until event (from when announcement is played)
                val minutesUntilEvent = ChronoUnit.MINUTES.between(ZonedDateTime.now(), finalEventTime)
                
                // Create announcement text (doorbell sound plays separately)
                val announcement = "Bedstemor, det er lauge: " + eventName + 
                    " klokken " + eventTimeFormatted + 
                    ", og der er " + minutesUntilEvent + " minutter til jeg skal v√¶re der"
                
                logInfo("LaugeReminder", "Announcing reminder: {}", announcement)
                
                // Play doorbell + announcement through Sonos speakers sequentially (one at a time):
                // .177 = Bedroom, .174 = Living room (surround coordinator), .171 = Bathroom, .170 = Kitchen
                executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", "192.168.100.177", announcement)
                Thread::sleep(1000)  // Brief pause between speakers
                executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", "192.168.100.174", announcement)
                Thread::sleep(1000)
                executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", "192.168.100.171", announcement)
                Thread::sleep(1000)
                executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", "192.168.100.170", announcement)
            ]
        } else {
            logDebug("LaugeReminder", "Event '{}' is too soon or in the past, reminder time would be {}",
                Lauge_Next_event_name.state.toString, reminderTime)
        }
        
    } catch (Exception e) {
        logError("LaugeReminder", "Error scheduling reminder: {}", e.getMessage())
    }
end
