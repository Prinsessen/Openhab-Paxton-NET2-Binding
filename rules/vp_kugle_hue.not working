// Define a variable outside of the rule execution scope to manage synchronization state
var Boolean syncing = false

rule "Synchronize Modbus and Hue Dimmer Bidirectional - Final Robust Version"
when
    Item Light_GF_VP_HUE_Bulb received update or
    Item Light_GF_VP_HUE_Bulb received command or
    Item Light17_Dimmer received update or
    Item Light17_Dimmer received command
then
    if (syncing === true) {
        return
    }
    syncing = true
    logInfo("DimmerSync", "Sync process started. Lock engaged.")

    try {
        // We cannot rely on 'triggeringItem' object. We check which item's state is *newly* different.
        
        // Scenario 1: Modbus item just received an update and Hue is different.
        if (Light_GF_VP_HUE_Bulb.state !== Light17_Dimmer.state) {
            logInfo("DimmerSync", "Modbus value is different from Hue. Syncing Modbus -> Hue.")
            Light17_Dimmer.sendCommand(Light_GF_VP_HUE_Bulb.state as Number)
        } 
        // Scenario 2: Hue item just received an update and Modbus is different.
        else if (Light17_Dimmer.state !== Light_GF_VP_HUE_Bulb.state) {
             logInfo("DimmerSync", "Hue value is different from Modbus. Syncing Hue -> Modbus.")
             Light_GF_VP_HUE_Bulb.sendCommand(Light17_Dimmer.state as Number)
        }
        else {
            logInfo("DimmerSync", "Items are already in sync. No command sent.")
        }
    }
    catch (Throwable e) {
        logError("DimmerSync", "Error during synchronization: " + e.getMessage())
    }
    finally {
        syncing = false
        logInfo("DimmerSync", "Synchronization complete. Lock released.")
    }
end