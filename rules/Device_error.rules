// *******************************************************************
// NILAN ERROR NOTIFICATION RULE
// *******************************************************************
// Optimized for Openhab 5.0

import java.time.ZonedDateTime

rule "Nilan Error Dummy"
when
    Item Nilan_error changed
then
	// Use idiomatic method call for postUpdate
	Nilan_error_Dummy.postUpdate(ON)
	// Log the actual state of the item using .state
	logInfo ("Device Error", "Nilan Dummy " + Nilan_error.state)
end

rule "Nilan Error - Send Mail Notification"
when
    Item Nilan_error_Dummy changed to ON
then
	logInfo("Device","Nilan Gateway Error")

    val timestamp = now.toString
    val gateway = "10.0.5.101"
    val deviceName = "Nilan Ventilation System"
    
    // Use method call style for getActions (ensuring the mail binding is configured)
    val mailActions = getActions("mail","mail:smtp:samplesmtp")		
 	
    // Build HTML email
    val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ff5252; color: white;'>" +
        "<tr><td style='padding: 20px;'>" +
        "<h2 style='margin: 0; margin-bottom: 5px;'>üö® Nilan Gateway Error</h2>" +
        "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>Device Offline Alert</p>" +
        "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ffebee;'>" +
        "<tr><td style='padding: 15px;'>" +
        "<h3 style='color: #ff5252; margin: 0; margin-bottom: 10px;'>‚ö†Ô∏è Connection Lost</h3>" +
        "<p style='margin: 5px 0; font-size: 14px;'>" + deviceName + " is offline and not responding.</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
        "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>üîå Device:</strong> " + deviceName + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #e8f5e9;'><strong>üåê Gateway IP:</strong> " + gateway + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #fff3e0;'><strong>üîß Action Required:</strong> Reboot gateway at " + gateway + "</td></tr>" +
        "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
        "<p style='margin: 0; color: #666; font-size: 13px;'>Automatic monitoring alert from OpenHAB</p>" +
        "</td></tr>" +
        "</table>" +
        "</body></html>"
    
    // Use unique variable names for success results to prevent naming conflicts
    val success1 = mailActions.sendHtmlMail("Nanna@agesen.dk", "üö® Nilan Gateway Error", emailBody)
	logInfo("Device Error - Nilan Gateway Error", "Mailactions says - " + success1)
    
    val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "Nilan Gateway Error", "Nilan Offline, reboot gateway at 10.0.5.101" )
	logInfo("Device Error - Nilan Gateway Error", "Mailactions says - " + success2)
	
	// Broadcast error via Sonos speakers with doorbell + TTS (non-blocking with timers)
	val nilanMessage = "Advarsel: Nilan Ventilation fejl. Systemet er offline, genstart gateway p√• 10.0.5.101"
	val nilanSpeakers = newArrayList("192.168.100.170", "192.168.100.171", "192.168.100.174", "192.168.100.177", "10.0.1.100")
	
	// Announce to first speaker immediately
	executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", nilanSpeakers.get(0), nilanMessage)
	
	// Schedule remaining speakers with 15-second delays to allow each to finish
	for (var i = 1; i < nilanSpeakers.size; i++) {
		val speakerIP = nilanSpeakers.get(i)
		val delaySeconds = i * 15
		createTimer(ZonedDateTime.now().plusSeconds(delaySeconds)) [ |
			executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", speakerIP, nilanMessage)
		]
	}
end

// *******************************************************************
// SMARTHOUSE ERROR NOTIFICATION RULE
// *******************************************************************
// Optimized for Openhab 5.0

rule "Smarthouse Error Dummy"
when
    Item Smarthouse_error changed
then
	// Use idiomatic method call for postUpdate
	Smarthouse_error_Dummy.postUpdate(ON)
	// Log the item's state using .state
	logInfo ("Device Error", "Smarthouse Dummy " + Smarthouse_error.state)
end

rule "Smarthouse Error - Send Mail Notification"
when
    Item Smarthouse_error_Dummy changed to ON
then
	// Log the item's state using .state
	logInfo ("Device Error", "Smarthouse " + Smarthouse_error_Dummy.state)
    
    val timestamp = now.toString
    val gateway = "192.168.100.86"
    val deviceName = "Smarthouse (Kirkegade)"
    
    // Get mail actions using method call style
    val mailActions = getActions("mail","mail:smtp:samplesmtp")		
 	
    // Build HTML email
    val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ff5252; color: white;'>" +
        "<tr><td style='padding: 20px;'>" +
        "<h2 style='margin: 0; margin-bottom: 5px;'>üö® Smarthouse Error</h2>" +
        "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>Device Offline Alert</p>" +
        "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ffebee;'>" +
        "<tr><td style='padding: 15px;'>" +
        "<h3 style='color: #ff5252; margin: 0; margin-bottom: 10px;'>‚ö†Ô∏è Connection Lost</h3>" +
        "<p style='margin: 5px 0; font-size: 14px;'>" + deviceName + " is offline and not responding.</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
        "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>üîå Device:</strong> " + deviceName + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #e8f5e9;'><strong>üåê Gateway IP:</strong> " + gateway + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #fff3e0;'><strong>üîß Action Required:</strong> Reboot gateway at " + gateway + "</td></tr>" +
        "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
        "<p style='margin: 0; color: #666; font-size: 13px;'>Automatic monitoring alert from OpenHAB</p>" +
        "</td></tr>" +
        "</table>" +
        "</body></html>"
    
    // Use unique variable names for success results to prevent naming conflicts
    val success1 = mailActions.sendHtmlMail("Nanna@agesen.dk", "üö® Smarthouse Error", emailBody)
	logInfo("Device Error - SMARTHOUSE ERROR", "Mailactions says - " + success1)
    
    val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "SMARTHOUSE ERROR", "Smarthouse Offline, reboot gateway at 192.168.100.86" )
	logInfo("Device Error - SMARTHOUSE ERROR", "Mailactions says - " + success2)
	
	// Broadcast error via Sonos speakers with doorbell + TTS (non-blocking with timers)
	val smarthouseMessage = "Advarsel: Smarthouse Kirkegade fejl. Systemet er offline, genstart gateway p√• 192.168.100.86"
	val smarthouseSpeakers = newArrayList("192.168.100.170", "192.168.100.171", "192.168.100.174", "192.168.100.177", "10.0.1.100")
	
	// Announce to first speaker immediately
	executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", smarthouseSpeakers.get(0), smarthouseMessage)
	
	// Schedule remaining speakers with 15-second delays
	for (var i = 1; i < smarthouseSpeakers.size; i++) {
		val speakerIP = smarthouseSpeakers.get(i)
		val delaySeconds = i * 15
		createTimer(ZonedDateTime.now().plusSeconds(delaySeconds)) [ |
			executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", speakerIP, smarthouseMessage)
		]
	}
end

// *******************************************************************
// SMA INVERTER ERROR NOTIFICATION RULE
// *******************************************************************
// Optimized for Openhab 5.0

rule "SMA Inverter Error Dummy"
when
    Item SMA_error changed
then
    // Use idiomatic method call for postUpdate
    SMA_error_Dummy.postUpdate(ON)
    // Log the item's state using .state
	logInfo ("Device Error", "SMA Dummy " + SMA_error.state)
end

rule "SMA Inverter Error - Send Mail Notification"
when
    Item SMA_error_Dummy changed to ON
then
    logInfo("Device Error","SMA Inverter Error")
    
    val timestamp = now.toString
    val gateway = "192.168.100.141"
    val deviceName = "SMA Solar Inverter"
    
    // Get mail actions using method call style
    val mailActions = getActions("mail","mail:smtp:samplesmtp")		
 	
    // Build HTML email
    val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ff5252; color: white;'>" +
        "<tr><td style='padding: 20px;'>" +
        "<h2 style='margin: 0; margin-bottom: 5px;'>üö® SMA Inverter Error</h2>" +
        "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>Solar System Offline</p>" +
        "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ffebee;'>" +
        "<tr><td style='padding: 15px;'>" +
        "<h3 style='color: #ff5252; margin: 0; margin-bottom: 10px;'>‚ö†Ô∏è Connection Lost</h3>" +
        "<p style='margin: 5px 0; font-size: 14px;'>" + deviceName + " is offline and not responding.</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
        "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>‚òÄÔ∏è Device:</strong> " + deviceName + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #e8f5e9;'><strong>üåê Gateway IP:</strong> " + gateway + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #fff3e0;'><strong>üîß Action Required:</strong> Reboot gateway at " + gateway + "</td></tr>" +
        "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
        "<p style='margin: 0; color: #666; font-size: 13px;'>Automatic monitoring alert from OpenHAB</p>" +
        "</td></tr>" +
        "</table>" +
        "</body></html>"
    
    // Use unique variable names for success results to prevent naming conflicts
    val success1 = mailActions.sendHtmlMail("Nanna@agesen.dk", "üö® SMA Inverter Error", emailBody)
	logInfo("Device Error - SMA INVERTER ERROR", "Mailactions says - " + success1)
    
    val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "SMA INVERTER ERROR", "SMA Inverter Offline, reboot gateway at 192.168.100.141" )
	logInfo("Device Error - SMA INVERTER ERROR", "Mailactions says - " + success2)
	
	// Broadcast error via Sonos speakers with doorbell + TTS (non-blocking with timers)
	val smaMessage = "Advarsel: Solcelle Inverter fejl. SMA systemet er offline, genstart gateway p√• 192.168.100.141"
	val smaSpeakers = newArrayList("192.168.100.170", "192.168.100.171", "192.168.100.174", "192.168.100.177", "10.0.1.100")
	
	// Announce to first speaker immediately
	executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", smaSpeakers.get(0), smaMessage)
	
	// Schedule remaining speakers with 15-second delays
	for (var i = 1; i < smaSpeakers.size; i++) {
		val speakerIP = smaSpeakers.get(i)
		val delaySeconds = i * 15
		createTimer(ZonedDateTime.now().plusSeconds(delaySeconds)) [ |
			executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", speakerIP, smaMessage)
		]
	}
end

// *******************************************************************
// METZ OUTPUT MODULE ERROR NOTIFICATION RULE
// *******************************************************************
// Optimized for Openhab 5.0

rule "METZ Output Error Dummy"
when
    Item Metz_error changed
then
	// Use idiomatic method call for postUpdate
	Metz_error_Dummy.postUpdate(ON)
	// Log the item's state using .state
	logInfo ("Device Error", "Metz Dummy " + Metz_error.state)
end


rule "METZ Output Error - Send Mail Notification"
when
    Item Metz_error_Dummy changed to ON
then
	// Use idiomatic method calls
	//NSPanel_Metz_error_Dummy.postUpdate(ON)
    // Log the item's state using .state
    logInfo("Device Error", "METZ Output Error " + Metz_error_Dummy.state)

    val timestamp = now.toString
    val gateway = "10.0.5.100"
    val deviceName = "METZ Output Module"
    
    // Get mail actions using method call style
	val mailActions = getActions("mail","mail:smtp:samplesmtp")		
 	
    // Build HTML email
    val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ff5252; color: white;'>" +
        "<tr><td style='padding: 20px;'>" +
        "<h2 style='margin: 0; margin-bottom: 5px;'>üö® METZ Output Error</h2>" +
        "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>Device Offline Alert</p>" +
        "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ffebee;'>" +
        "<tr><td style='padding: 15px;'>" +
        "<h3 style='color: #ff5252; margin: 0; margin-bottom: 10px;'>‚ö†Ô∏è Connection Lost</h3>" +
        "<p style='margin: 5px 0; font-size: 14px;'>" + deviceName + " is offline and not responding.</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
        "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>üîå Device:</strong> " + deviceName + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #e8f5e9;'><strong>üåê Gateway IP:</strong> " + gateway + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #fff3e0;'><strong>üîß Action Required:</strong> Reboot gateway at " + gateway + "</td></tr>" +
        "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
        "<p style='margin: 0; color: #666; font-size: 13px;'>Automatic monitoring alert from OpenHAB</p>" +
        "</td></tr>" +
        "</table>" +
        "</body></html>"
    
    // Use unique variable names for success results to prevent naming conflicts
 	val success1 = mailActions.sendHtmlMail("Nanna@agesen.dk", "üö® METZ Output Error", emailBody)
	logInfo("Device Error - METZ OUTPUT ERROR", "Mailactions says - " + success1)
    
    val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "METZ OUTPUT ERROR", "METZ Output Offline, reboot gateway at 10.0.5.100" )
	logInfo("Device Error - METZ OUTPUT ERROR", "Mailactions says - " + success2)
	
	// Broadcast error via Sonos speakers with doorbell + TTS (non-blocking with timers)
	val metzMessage = "Advarsel: METZ Output Module fejl. Systemet er offline, genstart gateway p√• 10.0.5.100"
	val metzSpeakers = newArrayList("192.168.100.170", "192.168.100.171", "192.168.100.174", "192.168.100.177", "10.0.1.100")
	
	// Announce to first speaker immediately
	executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", metzSpeakers.get(0), metzMessage)
	
	// Schedule remaining speakers with 15-second delays
	for (var i = 1; i < metzSpeakers.size; i++) {
		val speakerIP = metzSpeakers.get(i)
		val delaySeconds = i * 15
		createTimer(ZonedDateTime.now().plusSeconds(delaySeconds)) [ |
			executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", speakerIP, metzMessage)
		]
	}
end

// *******************************************************************
// Carbondioxide ERROR NOTIFICATION RULE
// *******************************************************************
// Optimized for Openhab 5.0

rule "Carbondioxide Sensor Dummy Error"
when
    Item carbondioxide_error changed
then
	// Use idiomatic method call for postUpdate
	carbondioxide_error_Dummy.postUpdate(ON)
	// Log the item's state using .state
	logInfo ("Device Error", "carbondioxide error Dummy " + carbondioxide_error.state)
end

rule "Carbondioxide Sensor Error - Send Mail Notification"
when
    Item carbondioxide_error_Dummy changed to ON
then
    logInfo("Device Error","Carbondioxide Sensor Error")
    
    val timestamp = now.toString
    val gateway = "10.0.5.100"
    val deviceName = "CO2 Sensor"
    
    // Get mail actions using method call style
	val mailActions = getActions("mail","mail:smtp:samplesmtp")		
 	
    // Build HTML email
    val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ff5252; color: white;'>" +
        "<tr><td style='padding: 20px;'>" +
        "<h2 style='margin: 0; margin-bottom: 5px;'>üö® CO2 Sensor Error</h2>" +
        "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>Air Quality Monitoring Offline</p>" +
        "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ffebee;'>" +
        "<tr><td style='padding: 15px;'>" +
        "<h3 style='color: #ff5252; margin: 0; margin-bottom: 10px;'>‚ö†Ô∏è Connection Lost</h3>" +
        "<p style='margin: 5px 0; font-size: 14px;'>" + deviceName + " is offline and not responding.</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
        "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>üå´Ô∏è Device:</strong> " + deviceName + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #e8f5e9;'><strong>üåê Gateway IP:</strong> " + gateway + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #fff3e0;'><strong>üîß Action Required:</strong> Reboot gateway at " + gateway + "</td></tr>" +
        "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
        "<p style='margin: 0; color: #666; font-size: 13px;'>Automatic monitoring alert from OpenHAB</p>" +
        "</td></tr>" +
        "</table>" +
        "</body></html>"
    
    // Use unique variable names for success results to prevent naming conflicts
 	val success1 = mailActions.sendHtmlMail("Nanna@agesen.dk", "üö® CO2 Sensor Error", emailBody)
	logInfo("Device Error - CARBONDIOXIDE SENSOR ERROR", "Mailactions says - " + success1)
    
    val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "CARBONDIOXIDE SENSOR ERROR", "Carbondioxide Sensor Offline, reboot gateway at 10.0.5.100" )
	logInfo("Device Error - CARBONDIOXIDE SENSOR ERROR", "Mailactions says - " + success2)
	
	// Broadcast error via Sonos speakers with doorbell + TTS (non-blocking with timers)
	val co2Message = "Advarsel: CO2 Sensor fejl. Luftkvalitets sensor er offline, genstart gateway p√• 10.0.5.100"
	val co2Speakers = newArrayList("192.168.100.170", "192.168.100.171", "192.168.100.174", "192.168.100.177", "10.0.1.100")
	
	// Announce to first speaker immediately
	executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", co2Speakers.get(0), co2Message)
	
	// Schedule remaining speakers with 15-second delays
	for (var i = 1; i < co2Speakers.size; i++) {
		val speakerIP = co2Speakers.get(i)
		val delaySeconds = i * 15
		createTimer(ZonedDateTime.now().plusSeconds(delaySeconds)) [ |
			executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", speakerIP, co2Message)
		]
	}
end

// *******************************************************************
// KAMPSTRUP MULTICAL 603 ERROR NOTIFICATION RULE
// *******************************************************************
// Optimized for Openhab 5.0

rule "Multical 603 Dummy Error"
when
    Item kampstrup_error changed
then
	// Use idiomatic method call for postUpdate
	kampstrup_error_Dummy.postUpdate(ON)
	// Log the item's state using .state
	logInfo ("Device Error", "Kampstrup error Dummy " + kampstrup_error.state)
end

rule "Multical 603  Error - Send Mail Notification"
when
     Item kampstrup_error_Dummy changed to ON
then
    logInfo("Device Error","Multical 603 Error")
    
    val timestamp = now.toString
    val gateway = "10.0.5.102"
    val deviceName = "Kampstrup Multical 603"
    
    // Get mail actions using method call style
	val mailActions = getActions("mail","mail:smtp:samplesmtp")		
 	
    // Build HTML email
    val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ff5252; color: white;'>" +
        "<tr><td style='padding: 20px;'>" +
        "<h2 style='margin: 0; margin-bottom: 5px;'>üö® Multical 603 Error</h2>" +
        "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>Heat Meter Offline</p>" +
        "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ffebee;'>" +
        "<tr><td style='padding: 15px;'>" +
        "<h3 style='color: #ff5252; margin: 0; margin-bottom: 10px;'>‚ö†Ô∏è Connection Lost</h3>" +
        "<p style='margin: 5px 0; font-size: 14px;'>" + deviceName + " is offline and not responding.</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
        "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>üå°Ô∏è Device:</strong> " + deviceName + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #e8f5e9;'><strong>üåê Gateway IP:</strong> " + gateway + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #fff3e0;'><strong>üîß Action Required:</strong> Reboot gateway at " + gateway + "</td></tr>" +
        "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
        "<p style='margin: 0; color: #666; font-size: 13px;'>Automatic monitoring alert from OpenHAB</p>" +
        "</td></tr>" +
        "</table>" +
        "</body></html>"
    
    // Use unique variable names for success results to prevent naming conflicts
 	val success1 = mailActions.sendHtmlMail("Nanna@agesen.dk", "üö® Multical 603 Error", emailBody)
	logInfo("Device Error - MULTICAL 603 ERROR", "Mailactions says - " + success1)
    
    val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "MULTICAL 603 ERROR", "Multical 603 Offline, reboot gateway at 10.0.5.102" )
	logInfo("Device Error - MULTICAL 603 ERROR", "Mailactions says - " + success2)	
	// Broadcast error via Sonos speakers with doorbell + TTS (non-blocking with timers)
	val kampstrupMessage = "Advarsel: Multical 603 m√•ler fejl. Varmem√•ler er offline, genstart gateway p√• 10.0.5.102"
	val kampstrupSpeakers = newArrayList("192.168.100.170", "192.168.100.171", "192.168.100.174", "192.168.100.177", "10.0.1.100")
	
	// Announce to first speaker immediately
	executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", kampstrupSpeakers.get(0), kampstrupMessage)
	
	// Schedule remaining speakers with 15-second delays
	for (var i = 1; i < kampstrupSpeakers.size; i++) {
		val speakerIP = kampstrupSpeakers.get(i)
		val delaySeconds = i * 15
		createTimer(ZonedDateTime.now().plusSeconds(delaySeconds)) [ |
			executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", speakerIP, kampstrupMessage)
		]
	}
end

// *******************************************************************
// SMARTHOUSE TERNDRUPVEJ ERROR NOTIFICATION RULE
// *******************************************************************
// Optimized for Openhab 5.0

rule "Smarthouse Terndrupvej Dummy Error"
when
    Item Smarthouse_error_Terndrupvej changed
then
	// Use idiomatic method call for postUpdate
	Smarthouse_error_Terndrupvej_Dummy.postUpdate(ON)
	// Log the item's state using .state
	logInfo ("Device Error", "Smarthouse_error_Terndrupvej Dummy " + Smarthouse_error_Terndrupvej.state)
end

rule "Smarthouse Terndrupvej  Error - Send Mail Notification"
when
    Item Smarthouse_error_Terndrupvej_Dummy changed to ON
then
    logInfo("Device Error","Smarthouse Terndrupvej Error")
    
    val timestamp = now.toString
    val gateway = "10.0.1.17"
    val deviceName = "Smarthouse (Terndrupvej)"
    
    // Get mail actions using method call style
	val mailActions = getActions("mail","mail:smtp:samplesmtp")		
 	
    // Build HTML email
    val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ff5252; color: white;'>" +
        "<tr><td style='padding: 20px;'>" +
        "<h2 style='margin: 0; margin-bottom: 5px;'>üö® Smarthouse Terndrupvej Error</h2>" +
        "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>Device Offline Alert</p>" +
        "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ffebee;'>" +
        "<tr><td style='padding: 15px;'>" +
        "<h3 style='color: #ff5252; margin: 0; margin-bottom: 10px;'>‚ö†Ô∏è Connection Lost</h3>" +
        "<p style='margin: 5px 0; font-size: 14px;'>" + deviceName + " is offline and not responding.</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
        "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>üí° Device:</strong> " + deviceName + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #e8f5e9;'><strong>üåê Gateway IP:</strong> " + gateway + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #fff3e0;'><strong>üîß Action Required:</strong> Reboot gateway at " + gateway + "</td></tr>" +
        "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
        "<p style='margin: 0; color: #666; font-size: 13px;'>Automatic monitoring alert from OpenHAB</p>" +
        "</td></tr>" +
        "</table>" +
        "</body></html>"
    
    // Use unique variable names for success results to prevent naming conflicts
 	val success1 = mailActions.sendHtmlMail("Nanna@agesen.dk", "üö® Smarthouse Terndrupvej Error", emailBody)
	logInfo("Device Error - SMARTHOUSE TERNDRUPVEJ ERROR", "Mailactions says - " + success1)
    
    val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "SMARTHOUSE TERNDRUPVEJ ERROR", "Smarthouse Terndrupvej Offline, reboot gateway at 10.0.1.17" )
	logInfo("Device Error - SMARTHOUSE TERNDRUPVEJ ERROR", "Mailactions says - " + success2)	
	// Broadcast error via Sonos speakers with doorbell + TTS (non-blocking with timers)
	val terndrupMessage = "Advarsel: Smarthouse Terndrupvej fejl. Systemet er offline, genstart gateway p√• 10.0.1.17"
	val terndrupSpeakers = newArrayList("192.168.100.170", "192.168.100.171", "192.168.100.174", "192.168.100.177", "10.0.1.100")
	
	// Announce to first speaker immediately
	executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", terndrupSpeakers.get(0), terndrupMessage)
	
	// Schedule remaining speakers with 15-second delays
	for (var i = 1; i < terndrupSpeakers.size; i++) {
		val speakerIP = terndrupSpeakers.get(i)
		val delaySeconds = i * 15
		createTimer(ZonedDateTime.now().plusSeconds(delaySeconds)) [ |
			executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", speakerIP, terndrupMessage)
		]
	}
end

// *******************************************************************
// MITSUBISHI LIVINGROOM ERROR NOTIFICATION RULE
// *******************************************************************
// Optimized for Openhab 5.0

rule "Mitsubishi Livingroom Dummy Error"
when
    Item Mitsubishi_living_error changed
then
	// Use idiomatic method call for postUpdate
	Mitsubishi_living_Dummy.postUpdate(ON)
	// Log the item's state using .state
	logInfo ("Device Error", "Mitsubishi Livingroom Dummy " + Mitsubishi_living_error.state)
end

rule "Mitsubishi Livingroom Error - Send Mail Notification"
when
    Item Mitsubishi_living_Dummy changed to ON
then
    logInfo("Device Error","Mitsubishi Livingroom Error")
    
    val timestamp = now.toString
    val gateway = "10.0.5.59"
    val deviceName = "Mitsubishi Heat Pump (Living Room)"
    
    // Get mail actions using method call style
	val mailActions = getActions("mail","mail:smtp:samplesmtp")		
 	
    // Build HTML email
    val emailBody = "<!DOCTYPE html><html><head><meta charset='UTF-8'></head><body style='margin: 0; padding: 0; font-family: Arial, sans-serif;'>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ff5252; color: white;'>" +
        "<tr><td style='padding: 20px;'>" +
        "<h2 style='margin: 0; margin-bottom: 5px;'>üö® Mitsubishi Heat Pump Offline</h2>" +
        "<p style='margin: 0; margin-bottom: 8px; font-size: 15px;'>Climate Control System Error</p>" +
        "<p style='margin: 0; font-size: 14px; opacity: 0.9;'>" + timestamp + "</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0' style='background: #ffebee;'>" +
        "<tr><td style='padding: 15px;'>" +
        "<h3 style='color: #ff5252; margin: 0; margin-bottom: 10px;'>‚ö†Ô∏è Connection Lost</h3>" +
        "<p style='margin: 5px 0; font-size: 14px;'>" + deviceName + " is offline and not responding.</p>" +
        "</td></tr>" +
        "</table>" +
        "<table width='100%' cellpadding='0' cellspacing='0' border='0'>" +
        "<tr><td style='padding: 10px; background: #e3f2fd;'><strong>‚ùÑÔ∏è Device:</strong> " + deviceName + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #e8f5e9;'><strong>üåê Gateway IP:</strong> " + gateway + "</td></tr>" +
        "<tr><td style='padding: 10px; background: #fff3e0;'><strong>üîß Action Required:</strong> Reboot gateway at " + gateway + "</td></tr>" +
        "<tr><td style='padding: 15px; text-align: center; background: #f5f5f5;'>" +
        "<p style='margin: 0; color: #666; font-size: 13px;'>Automatic monitoring alert from OpenHAB</p>" +
        "</td></tr>" +
        "</table>" +
        "</body></html>"
    
    // Use unique variable names for success results to prevent naming conflicts
 	val success1 = mailActions.sendHtmlMail("Nanna@agesen.dk", "üö® Mitsubishi Heat Pump Offline", emailBody)
	logInfo("Device Error - Mitsubishi Livingroom Error", "Mailactions says - " + success1)
    
    val success2 = mailActions.sendMail("20960210@sms.uni-tel.dk", "MITSUBISHI LIVINGROOM OFFLINE", "Mitsubishi Livingroom Offline, reboot gateway at 10.0.5.59" )
    logInfo("Device Error - Mitsubishi Livingroom Error", "Mailactions says - " + success2)	
	// Broadcast error via Sonos speakers with doorbell + TTS (non-blocking with timers)
	val mitsubishiMessage = "Advarsel: Varmepumpe Stue fejl. Mitsubishi varmepumpe er offline, genstart gateway p√• 10.0.5.59"
	val mitsubishiSpeakers = newArrayList("192.168.100.170", "192.168.100.171", "192.168.100.174", "192.168.100.177", "10.0.1.100")
	
	// Announce to first speaker immediately
	executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", mitsubishiSpeakers.get(0), mitsubishiMessage)
	
	// Schedule remaining speakers with 15-second delays
	for (var i = 1; i < mitsubishiSpeakers.size; i++) {
		val speakerIP = mitsubishiSpeakers.get(i)
		val delaySeconds = i * 15
		createTimer(ZonedDateTime.now().plusSeconds(delaySeconds)) [ |
			executeCommandLine(Duration.ofSeconds(60), "/etc/openhab/scripts/sonos_doorbell_tts.sh", speakerIP, mitsubishiMessage)
		]
	}
end