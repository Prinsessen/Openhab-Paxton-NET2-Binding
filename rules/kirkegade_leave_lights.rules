// ============================================================================
// Kirkegade 50 - Smart Lights On Exit/Enter (Dream Catcher Phone)
// ============================================================================
// Automatically manage lights when leaving/entering home via geofence
// - On EXIT: Save which lights are ON, then turn them OFF
// - On ENTER: Restore only the lights that were ON when you left
//
// Target geofence: "Garage Opener - Kirkegade 50"
// Controlled lights: All lights in Lights group (excludes outdoor/heating valves)
// ============================================================================

import java.time.LocalDateTime
import java.util.Map

// Global variable to store the state of lights when leaving
var Map<String, String> savedLightStates = null
var LocalDateTime lastExitTime = null

// ============================================================================
// RULE 1: Save and Turn OFF Lights When Leaving
// ============================================================================

rule "Kirkegade Lights - Save State and Turn OFF on Exit"
when
    Item Vehicle1_GeofenceEvent changed to "geofenceExit"
then
    // Check if automation is enabled
    if (Vehicle1_AutoLightsEnabled.state != ON) {
        logInfo("Kirkegade Lights", "Smart Lights automation is disabled - skipping")
        return
    }
    
    // Check if we're leaving geofence ID 1 (Kirkegade 50)
    val currentGeofenceId = Vehicle1_GeofenceId.state
    if (currentGeofenceId != 1) {
        logInfo("Kirkegade Lights", "Exiting geofence " + currentGeofenceId + " (not Kirkegade) - skipping")
        return
    }
    
    // We're leaving Kirkegade 50 (geofence ID 1)
    logInfo("Kirkegade Lights", "Dream Catcher exiting Kirkegade 50 (geofence 1) - saving light states")
    
    // Create a new map to store light states
    savedLightStates = newHashMap()
    lastExitTime = LocalDateTime.now
    
    // Iterate through all lights in the Lights group
    Lights.members.forEach[ light |
        val lightState = light.state
        val lightName = light.name
        
        // Skip Terndrupvej lights (different location)
        if (lightName.startsWith("Light_Terndrup") || lightName.contains("Terndrupvej")) {
            logInfo("Kirkegade Lights", "  Skipping Terndrupvej light: " + lightName)
            return
        }
        
        // Skip _Constant items (they are light sensors or control modes, not lights)
        if (lightName.contains("_Constant")) {
            return
        }
        
        // Skip outdoor/garden lights (Have group)
        if (lightName.startsWith("Light_Have") || lightName == "SG_Door") {
            logInfo("Kirkegade Lights", "  Skipping outdoor light: " + lightName)
            return
        }
        
        // Skip TV outlet in bedroom
        if (lightName == "Light_GF_Sove_TV") {
            logInfo("Kirkegade Lights", "  Skipping TV outlet: " + lightName)
            return
        }
        
        // Skip office Luceplan armatur
        if (lightName == "Light_GC_Kontor_Pendel") {
            logInfo("Kirkegade Lights", "  Skipping office armatur: " + lightName)
            return
        }
        
        // Check if light is ON (for switches) or brightness > 0 (for dimmers/numbers)
        var shouldSave = false
        var stateValue = ""
        
        if (lightState == ON) {
            // Switch is ON
            shouldSave = true
            stateValue = "ON"
        } else if (lightState instanceof Number || lightState instanceof DecimalType) {
            // Dimmer or Number type (including _Constant items) - check if brightness > 0
            val brightness = (lightState as Number).intValue
            if (brightness > 0) {
                shouldSave = true
                stateValue = brightness.toString
            }
        }
        
        if (shouldSave) {
            savedLightStates.put(light.name, stateValue)
            logInfo("Kirkegade Lights", "  Saved: " + light.name + " = " + stateValue)
            
            // Turn off the light (use 0 for dimmers/numbers, OFF for switches)
            if (stateValue == "ON") {
                light.sendCommand(OFF)
            } else {
                light.sendCommand(0)
            }
        }
    ]
    
    // Also handle Hue lights (not in Lights group)
    // Excluding Light4_Toggle (Living Room Triangle) and Light10_Toggle (Kitchen Hood Accent)
    
    // Light1_Toggle - Spisestue
    if (Light1_Toggle.state == ON) {
        savedLightStates.put("Light1_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light1_Toggle (Spisestue) = ON")
        Light1_Toggle.sendCommand(OFF)
    }
    
    // Light2_Toggle - Tvstue
    if (Light2_Toggle.state == ON) {
        savedLightStates.put("Light2_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light2_Toggle (Tvstue) = ON")
        Light2_Toggle.sendCommand(OFF)
    }
    
    // Light3_Toggle - Bedroom
    if (Light3_Toggle.state == ON) {
        savedLightStates.put("Light3_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light3_Toggle (Bedroom) = ON")
        Light3_Toggle.sendCommand(OFF)
    }
    
    // Light5_Toggle - Ensis UP
    if (Light5_Toggle.state == ON) {
        savedLightStates.put("Light5_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light5_Toggle (Ensis UP) = ON")
        Light5_Toggle.sendCommand(OFF)
    }
    
    // Light6_Toggle - Ensis Down
    if (Light6_Toggle.state == ON) {
        savedLightStates.put("Light6_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light6_Toggle (Ensis Down) = ON")
        Light6_Toggle.sendCommand(OFF)
    }
    
    // Light7_Toggle - MOON Maxi
    if (Light7_Toggle.state == ON) {
        savedLightStates.put("Light7_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light7_Toggle (MOON Maxi) = ON")
        Light7_Toggle.sendCommand(OFF)
    }
    
    // Light8_Toggle - MOON Midi
    if (Light8_Toggle.state == ON) {
        savedLightStates.put("Light8_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light8_Toggle (MOON Midi) = ON")
        Light8_Toggle.sendCommand(OFF)
    }
    
    // Light9_Toggle - MOON Mini
    if (Light9_Toggle.state == ON) {
        savedLightStates.put("Light9_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light9_Toggle (MOON Mini) = ON")
        Light9_Toggle.sendCommand(OFF)
    }
    
    // Light13_Toggle - Festivitas
    if (Light13_Toggle.state == ON) {
        savedLightStates.put("Light13_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light13_Toggle (Festivitas) = ON")
        Light13_Toggle.sendCommand(OFF)
    }
    
    // Light14_Toggle - Luceplan Group
    if (Light14_Toggle.state == ON) {
        savedLightStates.put("Light14_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light14_Toggle (Luceplan Group) = ON")
        Light14_Toggle.sendCommand(OFF)
    }
    
    // Light17_Toggle - VP Kugle
    if (Light17_Toggle.state == ON) {
        savedLightStates.put("Light17_Toggle", "ON")
        logInfo("Kirkegade Lights", "  Saved Hue: Light17_Toggle (VP Kugle) = ON")
        Light17_Toggle.sendCommand(OFF)
    }
    
    val lightsCount = savedLightStates.size
    logInfo("Kirkegade Lights", "Saved " + lightsCount + " lights that were ON. All lights turned OFF.")
end

// ============================================================================
// RULE 2: Restore Saved Lights When Entering
// ============================================================================

rule "Kirkegade Lights - Restore ON Lights on Enter"
when
    Item Vehicle1_GeofenceEvent changed to "geofenceEnter"
then
    // Check if automation is enabled
    if (Vehicle1_AutoLightsEnabled.state != ON) {
        logInfo("Kirkegade Lights", "Smart Lights automation is disabled - skipping")
        return
    }
    
    // Check if we're entering geofence ID 1 (Kirkegade 50)
    val currentGeofenceId = Vehicle1_GeofenceId.state
    if (currentGeofenceId != 1) {
        logInfo("Kirkegade Lights", "Entering geofence " + currentGeofenceId + " (not Kirkegade) - skipping")
        return
    }
    
    // We're entering Kirkegade 50 (geofence ID 1)
    logInfo("Kirkegade Lights", "Dream Catcher entering Kirkegade 50 (geofence 1) - restoring light states")
    
    if (savedLightStates !== null && !savedLightStates.isEmpty) {
        // Calculate time since exit
        var timeSinceExit = ""
        if (lastExitTime !== null) {
            val minutesAway = java.time.Duration.between(lastExitTime, LocalDateTime.now).toMinutes
            timeSinceExit = " (away for " + minutesAway + " minutes)"
        }
        
        logInfo("Kirkegade Lights", "Restoring " + savedLightStates.size + " lights" + timeSinceExit)
        
        // Restore each saved light
        savedLightStates.keySet.forEach[ lightName |
            val savedValue = savedLightStates.get(lightName)
            
            // Check if it's a Hue light or regular light
            if (lightName.startsWith("Light") && lightName.contains("_Toggle")) {
                // It's a Hue light - restore using switch statement
                logInfo("Kirkegade Lights", "  Restoring Hue: " + lightName + " = ON")
                
                switch lightName {
                    case "Light1_Toggle": Light1_Toggle.sendCommand(ON)
                    case "Light2_Toggle": Light2_Toggle.sendCommand(ON)
                    case "Light3_Toggle": Light3_Toggle.sendCommand(ON)
                    case "Light5_Toggle": Light5_Toggle.sendCommand(ON)
                    case "Light6_Toggle": Light6_Toggle.sendCommand(ON)
                    case "Light7_Toggle": Light7_Toggle.sendCommand(ON)
                    case "Light8_Toggle": Light8_Toggle.sendCommand(ON)
                    case "Light9_Toggle": Light9_Toggle.sendCommand(ON)
                    case "Light13_Toggle": Light13_Toggle.sendCommand(ON)
                    case "Light14_Toggle": Light14_Toggle.sendCommand(ON)
                    case "Light17_Toggle": Light17_Toggle.sendCommand(ON)
                }
            } else {
                // It's a regular light - find in Lights group
                val light = Lights.members.findFirst[ l | l.name == lightName ]
                
                if (light !== null) {
                    // Restore to previous state (ON for switches, or brightness level for dimmers)
                    if (savedValue == "ON") {
                        logInfo("Kirkegade Lights", "  Restoring: " + lightName + " = ON")
                        light.sendCommand(ON)
                    } else {
                        // Restore dimmer to previous brightness
                        logInfo("Kirkegade Lights", "  Restoring: " + lightName + " = " + savedValue + "%")
                        light.sendCommand(savedValue)
                    }
                } else {
                    logWarn("Kirkegade Lights", "  Could not find light: " + lightName)
                }
            }
        ]
        
        logInfo("Kirkegade Lights", "Light restoration complete")
    } else {
        logInfo("Kirkegade Lights", "No saved light states found - all lights remain off")
    }
end

// ============================================================================
// RULE 3: Clear Saved States on System Restart
// ============================================================================

rule "Kirkegade Lights - Initialize on System Start"
when
    System started
then
    savedLightStates = null
    lastExitTime = null
    logInfo("Kirkegade Lights", "System started - light state memory cleared")
end
